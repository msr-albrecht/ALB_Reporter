<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Berichtsgenerator</title>
    <link rel="stylesheet" href="style.css" type="text/css">
    <!-- Keycloak-JS lokal eingebunden -->
    <script src="keycloak-js/keycloak.min.js"></script>
</head>
<body style="display:none;" id="mainBody">
<div id="loadingKeycloak" style="text-align:center;margin-top:100px;">
    <h2>üîí Anmeldung erforderlich...</h2>
    <p>Bitte warten, Sie werden zur Anmeldung weitergeleitet.</p>
</div>
<div class="container" id="appContent" style="display:none;">
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <nav>
                    <ul>
                        <li id="csvTableNav" style="display:none;"><a href="./csv-table.html">CSV-Tabelle</a></li>
                        <li><a href="http://139.162.154.60:8180" target="_blank">üìÅ Dateibrowser</a></li>
                    </ul>
                </nav>
                <h1>üìä Berichtsgenerator</h1>
                <p>Erstellen Sie professionelle Berichte mit automatischer Nummerierung</p>
            </div>
            <div class="header-right">
                <button id="loginBtn" style="display:none;">Anmelden</button>
                <button id="logoutBtn" style="display:none;">Abmelden</button>
                <span id="userInfo"></span>
                <div class="report-number-input">
                    <label for="customReportNumber">Berichtsnummer:</label>
                    <input type="number" id="customReportNumber" name="customReportNumber"
                           placeholder="Auto" min="1" max="9999"
                           title="Benutzerdefinierte Berichtsnummer (optional)">
                    <small>Optional: Startnummer f√ºr den Bericht</small>
                </div>
            </div>
        </div>
    </div>

    <form id="berichtForm">
        <div class="form-group">
            <label for="documentType">Dokumenttyp *</label>
            <select id="documentType" name="documentType" required>
                <option value="">Bitte w√§hlen Sie einen Dokumenttyp...</option>
                <option value="bautagesbericht">üìä Bautagesbericht</option>
                <option value="regiebericht">üìã Regiebericht</option>
                <option value="regieantrag">üìù Regieantrag</option>
            </select>
        </div>

        <div class="form-group">
            <label for="kuerzel">Kunde/Projekt *</label>
            <select id="kuerzel" name="kuerzel" required>
                <option value="">Bitte w√§hlen Sie ein K√ºrzel...</option>
            </select>
        </div>

        <!-- Globales Datumsfeld nur f√ºr Bautagesberichte -->
        <div class="form-group" id="globalDateContainer" style="display: none;">
            <label for="globalDatum">Datum</label>
            <input type="date" id="globalDatum" name="globalDatum" style="width: 200px;">
        </div>

        <div class="form-group">
            <label>Mitarbeiter</label>

            <div class="multi-select-container">
                <div class="multi-select-header" id="mitarbeiterHeader">
                    <span class="placeholder">Mitarbeiter ausw√§hlen...</span>
                    <span class="arrow">‚ñº</span>
                </div>
                <div class="multi-select-dropdown" id="mitarbeiterDropdown">
                    <div class="loading">Lade Mitarbeiter...</div>
                </div>
                <input type="hidden" id="selectedMitarbeiter" name="selectedMitarbeiter">
            </div>
            <div id="selectedMitarbeiterList" class="selected-mitarbeiter-list"></div>
        </div>

        <!-- Material Felder f√ºr Regiebericht/Regieantrag -->
        <div id="materialSection" class="material-section" style="display: none;">
            <h3 class="material-title">üì¶ Materialangaben (Optional)</h3>
            <div id="materialList" class="material-list">
                <div class="material-item" data-index="0">
                    <div class="material-inputs">
                        <div class="material-input-group">
                            <label for="materialMenge_0">Menge</label>
                            <input type="number" id="materialMenge_0" name="materialMenge_0" min="0" step="0.01" placeholder="z.B. 5">
                        </div>
                        <div class="material-input-group">
                            <label for="materialEH_0">Einheit</label>
                            <input type="text" id="materialEH_0" name="materialEH_0" placeholder="z.B. STK, m, kg" maxlength="10">
                        </div>
                        <div class="material-input-group material-description">
                            <label for="materialBeschreibung_0">Materialbeschreibung</label>
                            <input type="text" id="materialBeschreibung_0" name="materialBeschreibung_0" placeholder="z.B. Kabel NYM-J 3x1,5mm¬≤">
                        </div>
                        <div class="material-actions">
                            <button type="button" class="btn-remove-material" onclick="removeMaterialItem(0)" style="display: none;">‚úï</button>
                        </div>
                    </div>
                </div>
            </div>
            <button type="button" id="addMaterialBtn" class="btn-add-material">‚ûï Material hinzuf√ºgen</button>
        </div>

        <!-- Betreff und Regieleistungen Felder f√ºr Regiebericht/Regieantrag -->
        <div id="regieMainFields" class="regie-main-fields" style="display: none;">
            <div class="form-group">
                <label for="betreff">Betreff *</label>
                <input type="text" id="betreff" name="betreff" placeholder="Betreff des Regieberichts/Regieantrags..." required>
            </div>

            <div class="form-group">
                <label for="regieleistungen">Regieleistungen / Leistungs√§nderungen *</label>
                <textarea id="regieleistungen" name="regieleistungen" placeholder="Beschreibung der Regieleistungen oder Leistungs√§nderungen..." required></textarea>
            </div>
        </div>

        <!-- Spezifische Textfelder f√ºr Regiebericht/Regieantrag -->
        <div id="regieTextFields" class="regie-text-fields" style="display: none;">
            <h3 class="regie-title">üìù Zus√§tzliche Angaben</h3>

            <div class="form-group">
                <label for="behinderungen">Behinderungen/Erschwernisse/Begehungen/Abnahme</label>
                <textarea id="behinderungen" name="behinderungen" placeholder="Beschreibung von Behinderungen oder Erschwernissen..."></textarea>
            </div>

            <div class="form-group">
                <label for="bedenkanmeldung">Bedenkanmeldung/Hinweise an den AG</label>
                <textarea id="bedenkanmeldung" name="bedenkanmeldung" placeholder="Bedenkanmeldungen oder Hinweise an den Auftraggeber..."></textarea>
            </div>
        </div>

        <!-- Spezifische Textfelder f√ºr Bautagesbericht -->
        <div id="bautagesTextFields" class="bautages-text-fields" style="display: none;">
            <div class="form-group">
                <label for="bautages_durchgefuehrte_arbeiten">Durchgef√ºhrte Arbeiten *</label>
                <textarea id="bautages_durchgefuehrte_arbeiten" name="bautages_durchgefuehrte_arbeiten" placeholder="Beschreibung der durchgef√ºhrten Arbeiten..." required></textarea>
            </div>
            <h3 class="bautages-title">üìù Zus√§tzliche Angaben</h3>
            <div class="form-group">
                <label for="bautages_bedenkanmeldung">Bedenkanmeldung/Hinweise an den AG</label>
                <textarea id="bautages_bedenkanmeldung" name="bautages_bedenkanmeldung" placeholder="Bedenkanmeldungen oder Hinweise an den Auftraggeber..."></textarea>
            </div>
            <div class="form-group">
                <label for="bautages_behinderungen">Behinderungen/Erschwernisse/Begehungen/Abnahme</label>
                <textarea id="bautages_behinderungen" name="bautages_behinderungen" placeholder="Beschreibung von Behinderungen oder Erschwernissen..."></textarea>
            </div>
        </div>

        <button type="submit" class="btn-submit">
            üìÑ Bericht erstellen
        </button>

        <div id="successMessage" class="success-message">
            <strong>‚úÖ Erfolg!</strong> Ihr Bericht wurde erfolgreich erstellt und gespeichert.
        </div>
    </form>

    <div class="reports-section">
        <div class="reports-header">
            <h2>üìã Gespeicherte Berichte</h2>
            <button id="showReportsBtn" class="btn-show">Berichte anzeigen</button>
        </div>

        <div id="reportsFilters" class="reports-filters" style="display: none;">
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="documentTypeFilter" data-icon="üìä">Dokumenttyp:</label>
                    <select id="documentTypeFilter">
                        <option value="">Alle Typen</option>
                        <option value="bautagesbericht">üìä Bautagesbericht</option>
                        <option value="regiebericht">üìã Regiebericht</option>
                        <option value="regieantrag">üìù Regieantrag</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="projectFilter" data-icon="üè¢">Projekt:</label>
                    <select id="projectFilter">
                        <option value="">Alle Projekte</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="searchFilter" data-icon="üîç">Suche:</label>
                    <input type="text" id="searchFilter" placeholder="Nach Name oder Kunde suchen...">
                </div>
            </div>

            <div class="filter-actions">
                <button id="clearFiltersBtn" class="btn-clear">üîÑ Filter zur√ºcksetzen</button>
            </div>
        </div>

        <div id="reportsList" class="reports-list">
            <div class="loading">Lade Berichte...</div>
        </div>
    </div>
</div>

<script>
// Keycloak initialisieren und Seite erst nach Login anzeigen
const mainBody = document.getElementById('mainBody');
const appContent = document.getElementById('appContent');
const loadingKeycloak = document.getElementById('loadingKeycloak');

const keycloak = new Keycloak({
    url: 'https://139.162.154.60:8443',
    realm: 'berichte',
    clientId: 'berichte-app'
});

keycloak.init({ onLoad: 'login-required' }).then(function(authenticated) {
    if (authenticated) {
        loadingKeycloak.style.display = 'none';
        appContent.style.display = 'block';
        mainBody.style.display = 'block';
        // ...hier kann die UI wie gehabt weiter initialisiert werden...
    } else {
        loadingKeycloak.innerHTML = '<h2>Fehler bei der Anmeldung!</h2>';
    }
}).catch(function() {
    loadingKeycloak.innerHTML = '<h2>Keycloak konnte nicht geladen werden!</h2>';
});

document.addEventListener('DOMContentLoaded', function() {
    // Keycloak Konfiguration
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const csvTableNav = document.getElementById('csvTableNav');

    function updateUI() {
        if (keycloak.authenticated) {
            loginBtn.style.display = 'none';
            logoutBtn.style.display = 'inline-block';
            userInfo.textContent = 'Angemeldet als: ' + (keycloak.tokenParsed.preferred_username || '');
            // Rollenpr√ºfung
            if (keycloak.hasRealmRole('verwalter')) {
                csvTableNav.style.display = 'inline-block';
            } else {
                csvTableNav.style.display = 'none';
            }
        } else {
            loginBtn.style.display = 'inline-block';
            logoutBtn.style.display = 'none';
            userInfo.textContent = '';
            csvTableNav.style.display = 'none';
        }
    }

    loginBtn.onclick = function() { keycloak.login(); };
    logoutBtn.onclick = function() { keycloak.logout(); };

    keycloak.init({ onLoad: 'login-required' }).then(function(authenticated) {
        updateUI();
    });

    console.log('Frontend loaded');

    const form = document.getElementById('berichtForm');
    const successMessage = document.getElementById('successMessage');
    const showReportsBtn = document.getElementById('showReportsBtn');
    const reportsList = document.getElementById('reportsList');
    const kuerzelSelect = document.getElementById('kuerzel');

    // Multi-select elements
    const mitarbeiterHeader = document.getElementById('mitarbeiterHeader');
    const mitarbeiterDropdown = document.getElementById('mitarbeiterDropdown');
    const selectedMitarbeiterInput = document.getElementById('selectedMitarbeiter');

    let selectedMitarbeiter = [];
    let allMitarbeiter = [];

    // Load CSV data for dropdown
    loadKuerzelOptions();
    loadMitarbeiterOptions();

    // Set default date to today
    document.getElementById('globalDatum').value = new Date().toISOString().split('T')[0];

    // Document type change handler
    document.getElementById('documentType').addEventListener('change', function() {
        const documentType = this.value;
        const materialSection = document.getElementById('materialSection');
        const regieTextFields = document.getElementById('regieTextFields');
        const zusatzInformationenSection = document.getElementById('zusatzInformationenSection');
        const regieMainFields = document.getElementById('regieMainFields');
        const baugatesTextFields = document.getElementById('bautagesTextFields');
        const globalDateContainer = document.getElementById('globalDateContainer');

        // Get the required fields for regie documents
        const betreffField = document.getElementById('betreff');
        const regieleistungenField = document.getElementById('regieleistungen');
        const durchgefuehrteArbeitenField = document.getElementById('bautages_durchgefuehrte_arbeiten');

        // Show sections for regiebericht and regieantrag
        if (documentType === 'regiebericht' || documentType === 'regieantrag') {
            if (materialSection) materialSection.style.display = 'block';
            if (regieTextFields) regieTextFields.style.display = 'block';
            if (regieMainFields) regieMainFields.style.display = 'block';
            if (zusatzInformationenSection) zusatzInformationenSection.style.display = 'none';
            if (baugatesTextFields) baugatesTextFields.style.display = 'none';
            if (globalDateContainer) globalDateContainer.style.display = 'none'; // Verstecken bei Regie

            // Set required attributes for regie documents
            if (betreffField) betreffField.required = true;
            if (regieleistungenField) regieleistungenField.required = true;
            // Remove required from bautages_durchgefuehrte_arbeiten
            if (durchgefuehrteArbeitenField) durchgefuehrteArbeitenField.required = false;
        } else if (documentType === 'bautagesbericht') {
            if (materialSection) materialSection.style.display = 'none';
            if (regieTextFields) regieTextFields.style.display = 'none';
            if (regieMainFields) regieMainFields.style.display = 'none';
            if (zusatzInformationenSection) zusatzInformationenSection.style.display = 'none';
            if (baugatesTextFields) baugatesTextFields.style.display = 'block'; // Show for bautagesbericht
            if (globalDateContainer) globalDateContainer.style.display = 'block'; // Anzeigen bei Bautagesbericht

            // Set required for bautages_durchgefuehrte_arbeiten
            if (durchgefuehrteArbeitenField) durchgefuehrteArbeitenField.required = true;
            // Remove required from regie fields
            if (betreffField) betreffField.required = false;
            if (regieleistungenField) regieleistungenField.required = false;
        } else {
            if (materialSection) materialSection.style.display = 'none';
            if (regieTextFields) regieTextFields.style.display = 'none';
            if (regieMainFields) regieMainFields.style.display = 'none';
            if (zusatzInformationenSection) zusatzInformationenSection.style.display = 'none'; // Hide for bautagesbericht
            if (baugatesTextFields) baugatesTextFields.style.display = 'none'; // Hide for bautagesbericht
            if (globalDateContainer) globalDateContainer.style.display = 'none'; // Verstecken bei anderen Typen

            // Remove required attributes for other document types
            if (betreffField) betreffField.required = false;
            if (regieleistungenField) regieleistungenField.required = false;
            if (durchgefuehrteArbeitenField) durchgefuehrteArbeitenField.required = false;
        }

        // Update mitarbeiter display
        updateSelectedMitarbeiterDisplay();
    });

    async function loadKuerzelOptions() {
        try {
            const response = await fetch('/api/kuerzel');
            const result = await response.json();

            if (result.success) {
                kuerzelSelect.innerHTML = '<option value="">Bitte w√§hlen Sie ein K√ºrzel...</option>';
                result.data.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.kuerzel;
                    option.textContent = `${item.kuerzel} - ${item.kunde}`;
                    option.dataset.kunde = item.kunde;
                    option.dataset.strasseKunde = item.strasseKunde;
                    option.dataset.ortKunde = item.ortKunde;
                    option.dataset.baustelle = item.baustelle;
                    option.dataset.strasseBaustelle = item.strasseBaustelle;
                    option.dataset.ortBaustelle = item.ortBaustelle;
                    option.dataset.auftragsNr = item.auftragsNr;
                    option.dataset.vergNr = item.vergNr;
                    kuerzelSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading kuerzel options:', error);
        }
    }

    async function loadMitarbeiterOptions() {
        try {
            const response = await fetch('/api/mitarbeiter');
            const result = await response.json();

            if (result.success) {
                allMitarbeiter = result.data;
                renderMitarbeiterDropdown();
            }
        } catch (error) {
            console.error('Error loading mitarbeiter options:', error);
            mitarbeiterDropdown.innerHTML = '<div class="error">Fehler beim Laden der Mitarbeiter</div>';
        }
    }

    function renderMitarbeiterDropdown() {
        mitarbeiterDropdown.innerHTML = allMitarbeiter.map((mitarbeiter, index) => `
            <div class="multi-select-option">
                <input type="checkbox" id="mitarbeiter_${index}" data-name="${mitarbeiter.name}" data-qualifikation="${mitarbeiter.qualifikation}">
                <label for="mitarbeiter_${index}">${mitarbeiter.name} (${mitarbeiter.qualifikation})</label>
            </div>
        `).join('');

        // Add event listeners to checkboxes
        mitarbeiterDropdown.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedMitarbeiter);
        });
    }

    function updateSelectedMitarbeiter() {
        const documentType = document.getElementById('documentType').value;

        // Vorherige Werte vollst√§ndig sichern - ALLE Eingabefelder
        const previousValues = {};
        document.querySelectorAll('input[id^="arbeitsdatum_von_"], input[id^="startzeit_"], input[id^="endzeit_"], input[id^="wz_anreise_"], input[id^="wz_heimreise_"]').forEach(input => {
            if (input.type === 'checkbox') {
                previousValues[input.id] = input.checked;
            } else {
                previousValues[input.id] = input.value;
            }
        });

        // Mitarbeiterauswahl neu aufbauen
        const neueAuswahl = [];
        mitarbeiterDropdown.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            const name = checkbox.dataset.name;
            const qualifikation = checkbox.dataset.qualifikation;

            // F√ºr Bautagesberichte: Pr√ºfen ob Mitarbeiter bereits ausgew√§hlt
            if (documentType === 'bautagesbericht') {
                const alreadySelected = neueAuswahl.some(m => m.name === name);
                if (alreadySelected) {
                    // Checkbox wieder deaktivieren
                    checkbox.checked = false;
                    return;
                }
            }

            neueAuswahl.push({ name, qualifikation });
        });

        selectedMitarbeiter = neueAuswahl;

        updateSelectedMitarbeiterDisplay(previousValues);
    }

    function updateSelectedMitarbeiterDisplay(previousValues = {}) {
        const documentType = document.getElementById('documentType').value;
        const selectedMitarbeiterList = document.getElementById('selectedMitarbeiterList');
        selectedMitarbeiterList.innerHTML = '';

        // Gruppiere Mitarbeiter nach Namen
        const mitarbeiterGroups = {};
        selectedMitarbeiter.forEach((mitarbeiter, idx) => {
            if (!mitarbeiterGroups[mitarbeiter.name]) {
                mitarbeiterGroups[mitarbeiter.name] = {
                    mitarbeiter: mitarbeiter,
                    indices: []
                };
            }
            mitarbeiterGroups[mitarbeiter.name].indices.push(idx);
        });

        // Erstelle f√ºr jede Gruppe einen Kasten
        Object.values(mitarbeiterGroups).forEach(group => {
            const { mitarbeiter, indices } = group;

            // Erstelle den Kasten-Header mit + Button nur beim ersten Eintrag
            let controlsHtml = '';
            if (documentType !== 'bautagesbericht') {
                controlsHtml = `<button type="button" class="btn-add-mitarbeiter-eintrag styled-plus" data-mitarbeiter-name="${mitarbeiter.name}">+</button>`;
            }

            let inputRowsHtml = '';
            indices.forEach((index, entryIndex) => {
                const dateFromId = `arbeitsdatum_von_${index}`;
                const startzeitId = `startzeit_${index}`;
                const endzeitId = `endzeit_${index}`;

                let dateInputsHtml = '';
                // F√ºr Bautagesberichte: Kein individuelles Datumsfeld
                if (documentType !== 'bautagesbericht') {
                    dateInputsHtml = `
                        <div class="date-input-wrapper">
                            <label for="${dateFromId}">Arbeitsdatum:</label>
                            <input type="date" id="${dateFromId}" name="arbeitsdatum_von_${index}" class="individual-date" required>
                        </div>
                    `;
                }

                let wzCheckboxHtml = '';
                // Checkboxen NUR anzeigen, wenn NICHT Bautagesbericht
                if (documentType !== 'bautagesbericht') {
                    wzCheckboxHtml = `
                        <div class="wz-checkbox-wrapper">
                            <label>
                                <input type="checkbox" id="wz_anreise_${index}" name="wz_anreise_${index}" class="wz-checkbox-anreise">
                                Anreise
                            </label>
                            <label style="margin-left:10px;">
                                <input type="checkbox" id="wz_heimreise_${index}" name="wz_heimreise_${index}" class="wz-checkbox-heimreise">
                                Heimreise
                            </label>
                        </div>
                    `;
                }

                // ‚úï Button nur f√ºr zus√§tzliche Eintr√§ge (nicht f√ºr den ersten)
                let removeButtonHtml = '';
                if (documentType !== 'bautagesbericht' && entryIndex > 0) {
                    removeButtonHtml = `<button type="button" class="btn-remove-mitarbeiter-eintrag" data-mitarbeiter-name="${mitarbeiter.name}" data-mitarbeiter-id="${index}" style="margin-left: 10px;">‚úï</button>`;
                }

                inputRowsHtml += `
                    <div class="input-row">
                        ${dateInputsHtml}
                        <div class="time-input-wrapper">
                            <label for="${startzeitId}">Von:</label>
                            <input type="time" id="${startzeitId}" name="startzeit_${index}" class="individual-time" value="08:00" required>
                        </div>
                        <div class="time-input-wrapper">
                            <label for="${endzeitId}">Bis:</label>
                            <input type="time" id="${endzeitId}" name="endzeit_${index}" class="individual-time" value="16:00" required>
                        </div>
                        ${wzCheckboxHtml}
                        ${removeButtonHtml}
                    </div>
                `;
            });

            const mitarbeiterInput = `
                <div class="mitarbeiter-input-group">
                    <h4 class="mitarbeiter-name">${mitarbeiter.name} (${mitarbeiter.qualifikation}) ${controlsHtml}</h4>
                    ${inputRowsHtml}
                </div>
            `;
            selectedMitarbeiterList.insertAdjacentHTML('beforeend', mitarbeiterInput);
        });

        // Werte wiederherstellen - verbesserte Logik
        setTimeout(() => {
            selectedMitarbeiter.forEach((mitarbeiter, index) => {
                const dateFromId = `arbeitsdatum_von_${index}`;
                const startzeitId = `startzeit_${index}`;
                const endzeitId = `endzeit_${index}`;
                const wzAnreise = document.getElementById(`wz_anreise_${index}`);
                const wzHeimreise = document.getElementById(`wz_heimreise_${index}`);

                // Verwende gespeicherte Werte oder Standardwerte
                if (dateInput && documentType !== 'bautagesbericht') {
                    dateInput.value = previousValues[dateFromId] || new Date().toISOString().split('T')[0];
                }
                if (startInput) {
                    startInput.value = previousValues[startzeitId] || '08:00';
                }
                if (endInput) {
                    endInput.value = previousValues[endzeitId] || '16:00';
                }
                if (wzAnreise) {
                    wzAnreise.checked = previousValues[`wz_anreise_${index}`] || false;
                }
                if (wzHeimreise) {
                    wzHeimreise.checked = previousValues[`wz_heimreise_${index}`] || false;
                }
            });
        }, 0);

        // Hidden input aktualisieren (alle Eintr√§ge als Array)
        const alleEintraege = selectedMitarbeiter.map((e, idx) => ({
            id: idx,
            name: e.name,
            qualifikation: e.qualifikation
        }));
        selectedMitarbeiterInput.value = JSON.stringify(alleEintraege);
    }

    // Funktion um einen zus√§tzlichen Mitarbeiter-Eintrag hinzuzuf√ºgen
    function addMitarbeiterEintrag(mitarbeiterName) {
        const mitarbeiter = allMitarbeiter.find(m => m.name === mitarbeiterName);
        if (!mitarbeiter) return;

        // Vollst√§ndige Wertsicherung vor √Ñnderungen
        const previousValues = {};
        document.querySelectorAll('input[id^="arbeitsdatum_von_"], input[id^="startzeit_"], input[id^="endzeit_"], input[id^="wz_anreise_"], input[id^="wz_heimreise_"]').forEach(input => {
            if (input.type === 'checkbox') {
                previousValues[input.id] = input.checked;
            } else {
                previousValues[input.id] = input.value;
            }
        });

        // F√ºge den Mitarbeiter zur Liste hinzu
        selectedMitarbeiter.push({ name: mitarbeiter.name, qualifikation: mitarbeiter.qualifikation });

        // Aktualisiere die Anzeige mit gespeicherten Werten
        updateSelectedMitarbeiterDisplay(previousValues);
    }

    // Funktion um einen Mitarbeiter-Eintrag zu entfernen
    function removeMitarbeiterEintrag(mitarbeiterName, entryId) {
        // Vollst√§ndige Wertsicherung vor √Ñnderungen
        const previousValues = {};
        document.querySelectorAll('input[id^="arbeitsdatum_von_"], input[id^="startzeit_"], input[id^="endzeit_"], input[id^="wz_anreise_"], input[id^="wz_heimreise_"]').forEach(input => {
            if (input.type === 'checkbox') {
                previousValues[input.id] = input.checked;
            } else {
                previousValues[input.id] = input.value;
            }
        });

        // Entferne den Eintrag aus der selectedMitarbeiter Liste
        selectedMitarbeiter.splice(entryId, 1);

        // Aktualisiere die Anzeige mit gespeicherten Werten
        updateSelectedMitarbeiterDisplay(previousValues);
    }

    // Event Delegation f√ºr + und ‚úï Buttons
    document.getElementById('selectedMitarbeiterList').addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-add-mitarbeiter-eintrag')) {
            const name = e.target.getAttribute('data-mitarbeiter-name');
            addMitarbeiterEintrag(name);
        }
        if (e.target.classList.contains('btn-remove-mitarbeiter-eintrag')) {
            const name = e.target.getAttribute('data-mitarbeiter-name');
            const id = parseInt(e.target.getAttribute('data-mitarbeiter-id'));
            removeMitarbeiterEintrag(name, id);
        }
    });

    // Toggle dropdown
    mitarbeiterHeader.addEventListener('click', function() {
        mitarbeiterDropdown.style.display = mitarbeiterDropdown.style.display === 'block' ? 'none' : 'block';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.multi-select-container')) {
            mitarbeiterDropdown.style.display = 'none';
        }
    });

    // Form submission
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submitted');

        const formData = new FormData(form);
        const selectedOption = kuerzelSelect.options[kuerzelSelect.selectedIndex];
        const documentType = formData.get('documentType');
        const isRegieDocument = documentType === 'regiebericht' || documentType === 'regieantrag';

        // Collect individual dates and times
        const individualDates = {};
        const individualTimes = {};
        const wzData = {};
        // NEU: alle Eintr√§ge auslesen
        const alleEintraege = [];
        selectedMitarbeiter.forEach((eintrag, index) => {
            // F√ºge den Mitarbeiter zur alleEintraege Array hinzu
            alleEintraege.push({
                id: index,
                name: eintrag.name,
                qualifikation: eintrag.qualifikation
            });

            const startzeitInput = formData.get(`startzeit_${index}`);
            const endzeitInput = formData.get(`endzeit_${index}`);

            // F√ºr Bautagesberichte: Globales Datum verwenden, f√ºr andere: individuelles Datum
            let dateInput;
            if (documentType === 'bautagesbericht') {
                dateInput = formData.get('globalDatum');
            } else {
                dateInput = formData.get(`arbeitsdatum_von_${index}`);
            }

            // NEU: Checkboxen f√ºr Anreise/Heimreise
            const wzAnreise = formData.get(`wz_anreise_${index}`) === 'on';
            const wzHeimreise = formData.get(`wz_heimreise_${index}`) === 'on';

            if (dateInput && startzeitInput && endzeitInput) {
                individualDates[`${eintrag.name}_${index}`] = dateInput;
                individualTimes[`${eintrag.name}_${index}`] = `${startzeitInput}-${endzeitInput}`;
                if (wzAnreise || wzHeimreise) {
                    wzData[`${eintrag.name}_${index}`] = {
                        anreise: wzAnreise,
                        heimreise: wzHeimreise,
                        kuerzel: formData.get('kuerzel') || ''
                    };
                }
            }
        });

        console.log('Selected Mitarbeiter:', selectedMitarbeiter);
        console.log('Alle Eintraege:', alleEintraege);

        // F√ºr Bautagesberichte: Globales Datum verwenden
        let finalArbeitsdatum;
        if (documentType === 'bautagesbericht') {
            finalArbeitsdatum = formData.get('globalDatum') || new Date().toISOString().split('T')[0];
        } else {
            finalArbeitsdatum = alleEintraege.length > 0 ?
                (formData.get(`arbeitsdatum_von_${alleEintraege[0].id}`) || new Date().toISOString().split('T')[0]) : new Date().toISOString().split('T')[0];
        }

        const firstEmployeeStartzeit = alleEintraege.length > 0 ? formData.get(`startzeit_${alleEintraege[0].id}`) || '08:00' : '08:00';
        const firstEmployeeEndzeit = alleEintraege.length > 0 ? formData.get(`endzeit_${alleEintraege[0].id}`) || '16:00' : '16:00';
        const firstEmployeeTime = `${firstEmployeeStartzeit}-${firstEmployeeEndzeit}`;

        // Collect materials for Regieberichte/Regieantr√§ge
        let materials = [];
        if (isRegieDocument) {
            const materialItems = document.querySelectorAll('.material-item');
            materialItems.forEach(item => {
                const index = item.dataset.index;
                const menge = formData.get(`materialMenge_${index}`);
                const einheit = formData.get(`materialEH_${index}`);
                const beschreibung = formData.get(`materialBeschreibung_${index}`);

                // Only add material if at least one field is filled
                if (menge || einheit || beschreibung) {
                    materials.push({
                        menge: menge || '',
                        einheit: einheit || '',
                        beschreibung: beschreibung || ''
                    });
                }
            });
        }

        // Collect specific text fields for Regie documents
        let regieTextData = {};
        if (isRegieDocument) {
            regieTextData = {
                betreff: formData.get('betreff') || '',
                regieleistungen: formData.get('regieleistungen') || '',
                behinderungen: formData.get('behinderungen') || '',
                bedenkanmeldung: formData.get('bedenkanmeldung') || ''
            };
        } else {
            // Bautagesbericht spezifische Felder
            regieTextData = {
                behinderungen: formData.get('bautages_behinderungen') || '',
                bedenkanmeldung: formData.get('bautages_bedenkanmeldung') || '',
                durchgefuehrte_arbeiten: formData.get('bautages_durchgefuehrte_arbeiten') || ''
            };
        }

        const data = {
            documentType: formData.get('documentType') || 'bautagesbericht',
            kuerzel: formData.get('kuerzel') || '',
            kunde: selectedOption.dataset.kunde || '',
            strasseKunde: selectedOption.dataset.strasseKunde || '',
            ortKunde: selectedOption.dataset.ortKunde || '',
            baustelle: selectedOption.dataset.baustelle || '',
            strasseBaustelle: selectedOption.dataset.strasseBaustelle || '',
            ortBaustelle: selectedOption.dataset.ortBaustelle || '',
            auftragsNr: selectedOption.dataset.auftragsNr || '',
            vergNr: selectedOption.dataset.vergNr || '',
            mitarbeiter: alleEintraege,
            arbeitsdatum: finalArbeitsdatum,
            arbeitszeit: firstEmployeeTime,
            individualDates: individualDates,
            individualTimes: individualTimes,
            wzData: Object.keys(wzData).length > 0 ? wzData : undefined,
            // Benutzerdefinierte Berichtsnummer (neu)
            customReportNumber: document.getElementById('customReportNumber').value || undefined,
            // Material data for Regieberichte/Regieantr√§ge
            materials: materials.length > 0 ? materials : undefined,
            // Regie-spezifische Textfelder
            regieTextData: Object.keys(regieTextData).length > 0 ? regieTextData : undefined
        };

        console.log('Sending data:', data);

        // Disable submit button during request
        const submitBtn = form.querySelector('.btn-submit');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '‚è≥ Erstelle Bericht...';
        submitBtn.disabled = true;

        try {
            const response = await fetch('/api/reports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            console.log('Response status:', response.status);
            const result = await response.json();
            console.log('Response data:', result);

            if (result.success) {
                successMessage.style.display = 'block';
                successMessage.innerHTML = `<strong>‚úÖ Erfolg!</strong> Bericht erfolgreich erstellt`;
                form.reset();

                // Berichtsnummer-Feld explizit zur√ºcksetzen
                document.getElementById('customReportNumber').value = '';

                selectedMitarbeiter = [];
                updateSelectedMitarbeiterDisplay();

                // Hide success message after 5 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);

                // Refresh reports list if it's visible
                if (reportsList.style.display === 'block') {
                    loadReports();
                }
            } else {
                alert('Fehler: ' + result.message);
            }
        } catch (error) {
            console.error('Error creating report:', error);
            alert('Fehler beim Erstellen des Berichts: ' + error.message);
        } finally {
            // Re-enable submit button
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    });

    // Show/Hide reports
    showReportsBtn.addEventListener('click', function() {
        const reportsFilters = document.getElementById('reportsFilters');
        if (reportsList.style.display === 'none' || reportsList.style.display === '') {
            reportsList.style.display = 'block';
            reportsFilters.style.display = 'block';
            showReportsBtn.textContent = 'Berichte ausblenden';
            loadReports();
        } else {
            reportsList.style.display = 'none';
            reportsFilters.style.display = 'none';
            showReportsBtn.textContent = 'Berichte anzeigen';
        }
    });

    // Filter functionality
    let allReports = [];
    let filteredReports = [];

    // Filter event listeners
    document.getElementById('documentTypeFilter').addEventListener('change', applyFilters);
    document.getElementById('projectFilter').addEventListener('change', applyFilters);
    document.getElementById('searchFilter').addEventListener('input', applyFilters);
    document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

    function getDocumentTypeDisplay(type) {
        switch(type) {
            case 'bautagesbericht': return 'üìä Bautagesbericht';
            case 'regiebericht': return 'üìã Regiebericht';
            case 'regieantrag': return 'üìù Regieantrag';
            default: return type;
        }
    }

    function applyFilters() {
        const documentTypeFilter = document.getElementById('documentTypeFilter').value;
        const projectFilter = document.getElementById('projectFilter').value;
        const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

        filteredReports = allReports.filter(report => {
            // Document type filter
            if (documentTypeFilter && report.documentType !== documentTypeFilter) {
                return false;
            }

            // Project filter
            if (projectFilter && report.kuerzel !== projectFilter) {
                return false;
            }

            // Search filter
            if (searchFilter) {
                const searchText = [
                    report.fileName || '',
                    report.kunde || '',
                    report.kuerzel || '',
                    getDocumentTypeDisplay(report.documentType)
                ].join(' ').toLowerCase();

                if (!searchText.includes(searchFilter)) {
                    return false;
                }
            }

            return true;
        });

        displayReports(filteredReports);
    }

    function clearFilters() {
        document.getElementById('documentTypeFilter').value = '';
        document.getElementById('projectFilter').value = '';
        document.getElementById('searchFilter').value = '';
        filteredReports = allReports;
        displayReports(filteredReports);
    }

    function populateProjectFilter() {
        const projectFilter = document.getElementById('projectFilter');
        const projects = [...new Set(allReports.map(report => report.kuerzel))].sort();

        projectFilter.innerHTML = '<option value="">Alle Projekte</option>';
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            projectFilter.appendChild(option);
        });
    }

    function displayReports(reports) {
        if (reports.length === 0) {
            reportsList.innerHTML = '<div class="loading">Keine Berichte entsprechen den Filterkriterien.</div>';
            return;
        }

        reportsList.innerHTML = reports.map(report => `
            <div class="report-item" data-type="${report.documentType}" data-project="${report.kuerzel}">
                <div class="report-header">
                    <h3>${report.fileName || `Bericht #${report.reportNumber.toString().padStart(4, '0')}`}</h3>
                    <span class="report-type-badge">${getDocumentTypeDisplay(report.documentType)}</span>
                </div>
                <div class="report-details">
                    <p><strong>Projekt:</strong> ${report.kuerzel}</p>
                    <p><strong>Kunde:</strong> ${report.kunde || 'N/A'}</p>
                    <p><strong>Datum:</strong> ${report.arbeitsdatum || 'N/A'}</p>
                    <p><strong>Arbeitszeit:</strong> ${report.arbeitszeit || 'N/A'}</p>
                    <p><strong>Erstellt:</strong> ${new Date(report.createdAt).toLocaleString('de-DE')}</p>
                    ${report.zusatzInformationen ? `<p><strong>Zusatz:</strong> ${report.zusatzInformationen}</p>` : ''}
                </div>
                <div class="report-actions">
                    <button class="btn-delete" onclick="deleteReport('${report.id}')">üóëÔ∏è L√∂schen</button>
                    <a href="/api/reports/${report.id}/download" target="_blank" class="btn-download">üìÑ Herunterladen</a>
                </div>
            </div>
        `).join('');
    }

    // Load reports function
    async function loadReports() {
        console.log('Loading reports...');
        reportsList.innerHTML = '<div class="loading">Lade Berichte...</div>';

        try {
            const response = await fetch('/api/reports');
            console.log('Reports response status:', response.status);
            const result = await response.json();
            console.log('Reports data:', result);

            if (result.success && result.reports.length > 0) {
                allReports = result.reports;
                filteredReports = allReports;
                populateProjectFilter();
                displayReports(filteredReports);
            } else {
                reportsList.innerHTML = '<div class="loading">Keine Berichte vorhanden.</div>';
            }
        } catch (error) {
            console.error('Error loading reports:', error);
            reportsList.innerHTML = '<div class="loading">Fehler beim Laden der Berichte.</div>';
        }
    }

    // Material section dynamic item handling
    let materialItemIndex = 1;

    document.getElementById('addMaterialBtn').addEventListener('click', function() {
        const materialList = document.getElementById('materialList');
        const newItem = document.createElement('div');
        newItem.className = 'material-item';
        newItem.dataset.index = materialItemIndex;

        newItem.innerHTML = `
            <div class="material-inputs">
                <div class="material-input-group">
                    <label for="materialMenge_${materialItemIndex}">Menge</label>
                    <input type="number" id="materialMenge_${materialItemIndex}" name="materialMenge_${materialItemIndex}" min="0" step="0.01" placeholder="z.B. 5">
                </div>
                <div class="material-input-group">
                    <label for="materialEH_${materialItemIndex}">Einheit</label>
                    <input type="text" id="materialEH_${materialItemIndex}" name="materialEH_${materialItemIndex}" placeholder="z.B. STK, m, kg" maxlength="10">
                </div>
                <div class="material-input-group material-description">
                    <label for="materialBeschreibung_${materialItemIndex}">Materialbeschreibung</label>
                    <input type="text" id="materialBeschreibung_${materialItemIndex}" name="materialBeschreibung_${materialItemIndex}" placeholder="z.B. Kabel NYM-J 3x1,5mm¬≤">
                </div>
                <div class="material-actions">
                    <button type="button" class="btn-remove-material" onclick="removeMaterialItem(${materialItemIndex})">‚úï</button>
                </div>
            </div>
        `;

        materialList.appendChild(newItem);
        materialItemIndex++;
    });

    function removeMaterialItem(index) {
        const itemToRemove = document.querySelector(`.material-item[data-index="${index}"]`);
        if (itemToRemove) {
            itemToRemove.remove();
        }
    }

    // Delete report function
    window.deleteReport = async function(reportId) {
        if (!confirm('Sind Sie sicher, dass Sie diesen Bericht l√∂schen m√∂chten? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
            return;
        }

        try {
            const response = await fetch(`/api/reports/${reportId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const result = await response.json();

            if (result.success) {
                // Show success message
                const tempSuccessMessage = document.createElement('div');
                tempSuccessMessage.className = 'success-message';
                tempSuccessMessage.innerHTML = '<strong>‚úÖ Erfolg!</strong> Bericht wurde erfolgreich gel√∂scht.';
                tempSuccessMessage.style.display = 'block';

                document.querySelector('.container').insertBefore(tempSuccessMessage, document.querySelector('form'));

                // Hide success message after 3 seconds
                setTimeout(() => {
                    tempSuccessMessage.remove();
                }, 3000);

                // Refresh reports list
                loadReports();
            } else {
                alert('Fehler beim L√∂schen: ' + result.message);
            }
        } catch (error) {
            console.error('Error deleting report:', error);
            alert('Fehler beim L√∂schen des Berichts: ' + error.message);
        }
    }
});
</script>
</body>
</html>
